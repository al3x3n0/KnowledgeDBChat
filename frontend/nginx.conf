server {
    listen 80;
    server_name localhost;
    
    # DNS resolver for Docker service names
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 5s;
    
    # Allow large file uploads (2GB for videos/audio)
    client_max_body_size 2048M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Video streaming proxy (must come before /api/)
    # Maps /video/{document_id} to video-streamer /stream/{document_id}
    location ~ ^/video/(.+)$ {
        # Use variable for proxy_pass to enable DNS resolution
        set $video_streamer "http://video-streamer:8080";
        # Preserve query parameters ($is_args$args)
        proxy_pass $video_streamer/stream/$1$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve Range header for video streaming
        proxy_set_header Range $http_range;
        
        # Preserve Authorization header if present
        proxy_set_header Authorization $http_authorization;
        
        # Increase timeouts for video streaming
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        send_timeout 300;
        
        # Disable buffering for streaming
        proxy_buffering off;
        proxy_request_buffering off;
        
        # Allow large file downloads
        client_max_body_size 0;
        
        # Don't add CORS headers here - video-streamer handles CORS
        # Adding them here causes duplicate headers which browsers reject
    }

    # API proxy (must come before / location)
    # Handles both HTTP API requests and WebSocket connections
    location /api/ {
        # Use variable-based proxy_pass so nginx re-resolves the Docker DNS name.
        # Without this, nginx may cache the backend container IP and keep sending traffic
        # to a dead IP after backend restarts (causing intermittent 502 "connection refused").
        set $backend_upstream "http://backend:8000";
        proxy_pass $backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Allow large file uploads (2GB for videos/audio)
        client_max_body_size 2048M;
        
        # Increase timeouts for large file uploads
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        send_timeout 300;
        
        # Disable buffering for large uploads
        proxy_buffering off;
        proxy_request_buffering off;
        
        # WebSocket support (for /api/v1/chat/sessions/{id}/ws)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # CORS headers for API (let backend handle CORS to avoid conflicts)
        # Note: Backend already sets CORS headers, nginx should not duplicate them
        # Only handle OPTIONS preflight if backend doesn't
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
    }

    # MinIO proxy for file downloads (must come before / location)
    location /minio/ {
        # Variable-based proxy_pass to allow DNS re-resolution on container restarts.
        set $minio_upstream "http://minio:9000";
        proxy_pass $minio_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Important: Preserve query parameters for presigned URLs
        proxy_set_header X-Forwarded-Host $host;
        
        # Increase timeouts for large file downloads
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        send_timeout 300;
        
        # Disable buffering for streaming downloads
        proxy_buffering off;
        proxy_request_buffering off;
        
        # Allow large file uploads/downloads
        client_max_body_size 0;
    }

    # Frontend proxy (React dev server) - catch-all for everything else
    location / {
        # Variable-based proxy_pass to allow DNS re-resolution on container restarts.
        set $frontend_upstream "http://frontend:3000";
        proxy_pass $frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for React dev server (HMR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for long-running requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}



